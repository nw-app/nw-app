rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAdmin() {
      return (request.auth != null && request.auth.token.email == "nwapp.eason@gmail.com")
        || (exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == "系統管理員");
    }

    function isCommunityStaff() {
       return exists(/databases/$(database)/documents/users/$(request.auth.uid))
         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') != "住戶"
         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') != "停用";
    }

    match /users/{uid} {
      allow read: if request.auth != null && (
        request.auth.uid == uid || 
        isAdmin() || 
        (isCommunityStaff() && resource.data.community == getUserData().community)
      );
      
      allow create: if request.auth != null && (
        isAdmin() || 
        (isCommunityStaff() && request.resource.data.community == getUserData().community)
      );
      
      allow update: if request.auth != null && (
        request.auth.uid == uid || 
        isAdmin() || 
        (isCommunityStaff() && resource.data.community == getUserData().community)
      );
      
      allow delete: if request.auth != null && (
        isAdmin() || 
        (isCommunityStaff() && resource.data.community == getUserData().community)
      );
    }
    
    match /user_lookup/{phone} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    match /communities/{slug} {
      // 允許任何人讀取社區基本資料 (for 預覽頁面)
      allow read: if true;
      allow update: if request.auth != null && (isAdmin() || (isCommunityStaff() && slug == getUserData().community));
      allow create, delete: if isAdmin();
      
      match /app_modules/{module} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && (isAdmin() || (isCommunityStaff() && slug == getUserData().community));
      }

      match /announcements/{announceId} {
        // 允許任何人讀取公告 (for 預覽頁面)
        allow read: if true;
        allow write: if request.auth != null && (isAdmin() || (isCommunityStaff() && slug == getUserData().community));
      }

      match /settings/{settingId} {
        // 允許任何人讀取設定 (for 設施預覽頁面)
        allow read: if true;
        allow write: if request.auth != null && (isAdmin() || (isCommunityStaff() && slug == getUserData().community));
      }

      match /facility_configs/{configId} {
        // 允許任何人讀取設施設定 (for 設施預覽頁面)
        allow read: if true;
        allow write: if request.auth != null && (isAdmin() || (isCommunityStaff() && slug == getUserData().community));
      }

      match /reservations/{resId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update, delete: if request.auth != null && (
          isAdmin() || 
          (isCommunityStaff() && slug == getUserData().community) ||
          resource.data.createdBy == request.auth.uid
        );
      }

      match /mails/{mailId} {
        allow read: if request.auth != null && (
          isAdmin() || 
          (isCommunityStaff() && slug == getUserData().community) ||
          (getUserData().houseNo == resource.data.houseNo)
        );
        allow write: if request.auth != null && (
          isAdmin() || 
          (isCommunityStaff() && slug == getUserData().community)
        );
      }

      match /points_logs/{logId} {
        allow read: if request.auth != null && (
          isAdmin() || 
          (isCommunityStaff() && slug == getUserData().community) ||
          resource.data.houseNo == getUserData().houseNo
        );
        allow create: if request.auth != null;
      }
    }

    // --- SOS 警報規則 (關鍵修復) ---
    match /sos_alerts/{alertId} {
      // 允許任何已登入使用者發送求救
      allow create: if request.auth != null;
      // 僅允許系統管理員，或同社區的管理員/總幹事讀取與解除警報
      allow read, update, delete: if request.auth != null && (
        isAdmin() || 
        (isCommunityStaff() && resource.data.community == getUserData().community)
      );
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}